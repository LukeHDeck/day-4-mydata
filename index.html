<!DOCTYPE html>
<html>
<head>
    <title>Lambertville Trees</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        html,
        body,
        #map {
            height: 100%;
        }

        #controls {
            position: absolute;
            right: 15px;
            top: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1;
            max-width: 280px;
        }

        #controls h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }

        .control-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 8px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .control-group input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
        }

        @media only screen and (max-width: 640px) {
            #controls {
                max-width: calc(100% - 30px);
                max-height: 50vh;
                overflow-y: auto;
            }
        }
    </style>
</head>

<body>
    <div id="map"></div>
    
    <div id="controls">
        <h3>Tree Scale Controls</h3>
        <div class="control-group">
            <label>Extra Large Trees</label>
            <input type="number" id="scale-extra-large" min="0.1" max="100" step="0.1" value="20">
        </div>
        <div class="control-group">
            <label>Large Trees</label>
            <input type="number" id="scale-large" min="0.1" max="100" step="0.1" value="20">
        </div>
        <div class="control-group">
            <label>Medium Trees</label>
            <input type="number" id="scale-medium" min="0.1" max="100" step="0.1" value="20">
        </div>
        <div class="control-group">
            <label>Small Trees</label>
            <input type="number" id="scale-small" min="0.1" max="100" step="0.1" value="20">
        </div>
        <div class="control-group" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
            <label>Model Brightness</label>
            <input type="number" id="emissive-strength" min="0" max="1" step="0.05" value="0">
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
    
    <script>
        // IMPORTANT: Replace this with your GitHub Pages URL
        // Format: https://YOUR_USERNAME.github.io/YOUR_REPO/models/
        const MODEL_BASE_URL = 'https://LukeHDeck.github.io/day-4-mydata/models';
        
        // Access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGVja2RvZyIsImEiOiJjbDl5YWJydXcwMnl6M3Jrbml2djd5ZTJtIn0.hFpqesRFKogZg_ku3KKS_A';
        
        // Scale values for each tree type
        let scales = {
            'extra-large': 20,
            'large': 20,
            'medium': 20,
            'small': 20
        };
        
        // Emissive strength (brightness)
        let emissiveStrength = 0;
        
        // Initialize map
        const map = new mapboxgl.Map({
            container: 'map',
            center: [-74.945, 40.367], // Lambertville, NJ
            zoom: 16,
            pitch: 60,
            bearing: 0,
            style: 'mapbox://styles/deckdog/cmhpg30ke001u01rx9dda1l8i',
            minZoom: 14,
            maxZoom: 22,
            hash: true,
            antialias: true
        });

        // Set up scale controls
        ['extra-large', 'large', 'medium', 'small'].forEach(type => {
            const input = document.getElementById(`scale-${type}`);
            
            const handleUpdate = (e) => {
                const value = parseFloat(e.target.value);
                if (value >= 0.1 && value <= 100) {
                    scales[type] = value;
                    updateTreeLayer();
                }
            };
            
            input.addEventListener('input', handleUpdate);
            input.addEventListener('change', handleUpdate);
        });
        
        // Set up emissive strength control
        const emissiveInput = document.getElementById('emissive-strength');
        const handleEmissiveUpdate = (e) => {
            const value = parseFloat(e.target.value);
            if (value >= 0 && value <= 1) {
                emissiveStrength = value;
                updateTreeLayer();
            }
        };
        emissiveInput.addEventListener('input', handleEmissiveUpdate);
        emissiveInput.addEventListener('change', handleEmissiveUpdate);

        // Helper function to create scale expression (unchanged)
        function createScaleExpression() {
            const extraLarge = scales['extra-large'];
            const large = scales['large'];
            const medium = scales['medium'];
            const small = scales['small'];
            
            return [
                'case',
                ['==', ['get', 'type'], 'extra-large'], ['literal', [extraLarge, extraLarge, extraLarge]],
                ['==', ['get', 'type'], 'large'],       ['literal', [large, large, large]],
                ['==', ['get', 'type'], 'medium'],      ['literal', [medium, medium, medium]],
                                                      ['literal', [small, small, small]] // default to small
            ];
        }

        // Update tree (cube) layer with new scales and emissive strength
        function updateTreeLayer() {
            if (map.getLayer('tree-layer')) {
                map.setPaintProperty('tree-layer', 'model-scale', createScaleExpression());
                map.setPaintProperty('tree-layer', 'model-emissive-strength', emissiveStrength);
            }
        }

        // Handle map style loading
        map.on('style.load', () => {
            console.log('Map style loaded');
            
            // Set the light preset
            map.setConfigProperty('basemap', 'lightPreset', 'day');
            
            // Fetch and add the GeoJSON source
            fetch('./lambertville-trees-v1.geojson')
                .then(response => response.json())
                .then(data => {
                    // Filter out features without a valid type and add index
                    data.features = data.features.filter(feature => {
                        return feature.properties && 
                               feature.properties.type && 
                               ['extra-large', 'large', 'medium', 'small'].includes(feature.properties.type);
                    });
                    
                    // Add a numeric index to each feature for consistent randomization
                    data.features.forEach((feature, index) => {
                        feature.properties.index = index;
                    });
                    
                    console.log(`Loaded ${data.features.length} valid trees`);
                    console.log('Sample tree:', data.features[0]);

                    // Add the trees GeoJSON source
                    map.addSource('trees', {
                        'type': 'geojson',
                        'data': data
                    });
                    
                    console.log('Trees source added');
                    
                    // Add the model layer â€“ now always using test-cube.glb
                    map.addLayer({
                        'id': 'tree-layer',
                        'type': 'model',
                        'slot': 'middle',
                        'source': 'trees',
                        'layout': {
                            // Every feature uses the same cube model
                            'model-id': `${MODEL_BASE_URL}/test-cube.glb`
                        },
                        'paint': {
                            // Slight color variation for visual interest (optional)
                            'model-color': [
                                'hsla',
                                ['random', 80, 120, ['get', 'index']],
                                50,
                                ['random', 40, 60, ['get', 'index']],
                                1
                            ],
                            'model-color-mix-intensity': 0.15,
                            'model-opacity': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                14, 0,
                                15, 1
                            ],
                            // Keep rotation off for drift testing
                            // 'model-rotation': [0, 0, 0],
                            'model-scale': createScaleExpression(),
                            'model-cast-shadows': true,
                            'model-emissive-strength': emissiveStrength
                        },
                        'minzoom': 14,
                        'maxzoom': 22
                    });
                    
                    console.log('Tree (cube) layer added');
                })
                .catch(error => {
                    console.error('Error loading GeoJSON:', error);
                    alert('Failed to load tree data. Make sure lambertville-trees-v1.geojson is in the same directory as this HTML file.');
                });
        });
        
        // Log any errors
        map.on('error', (e) => {
            console.error('Map error:', e);
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-left');

        // Performance optimization
        map.on('idle', () => {
            map.repaint = false;
        });

        map.on('move', () => {
            map.repaint = true;
        });
    </script>
</body>
</html>
