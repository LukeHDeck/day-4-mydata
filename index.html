<!DOCTYPE html>
<html>
<head>
    <title>Lambertville Trees</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        html,
        body,
        #map {
            height: 100%;
        }

        #controls {
            position: absolute;
            right: 15px;
            top: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1;
            max-width: 280px;
        }

        #controls h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }

        .control-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 8px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .control-group .value-display {
            text-align: right;
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 500;
        }

        @media only screen and (max-width: 640px) {
            #controls {
                max-width: calc(100% - 30px);
                max-height: 50vh;
                overflow-y: auto;
            }
        }
    </style>
</head>

<body>
    <div id="map"></div>
    
    <div id="controls">
        <h3>Tree Scale Controls</h3>
        <div class="control-group">
            <label>Extra Large Trees</label>
            <input type="range" id="scale-extra-large" min="0.5" max="2.0" step="0.1" value="1.0">
            <div class="value-display">Scale: <span id="value-extra-large">1.0</span></div>
        </div>
        <div class="control-group">
            <label>Large Trees</label>
            <input type="range" id="scale-large" min="0.5" max="2.0" step="0.1" value="1.0">
            <div class="value-display">Scale: <span id="value-large">1.0</span></div>
        </div>
        <div class="control-group">
            <label>Medium Trees</label>
            <input type="range" id="scale-medium" min="0.5" max="2.0" step="0.1" value="1.0">
            <div class="value-display">Scale: <span id="value-medium">1.0</span></div>
        </div>
        <div class="control-group">
            <label>Small Trees</label>
            <input type="range" id="scale-small" min="0.5" max="2.0" step="0.1" value="1.0">
            <div class="value-display">Scale: <span id="value-small">1.0</span></div>
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
    
    <script>
        // IMPORTANT: Replace this with your GitHub Pages URL
        // Format: https://YOUR_USERNAME.github.io/YOUR_REPO/models/
        const MODEL_BASE_URL = 'https://LukeHDeck.github.io/day-4-my-data/models/';
        
        // Access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGVja2RvZyIsImEiOiJjbDl5YWJydXcwMnl6M3Jrbml2djd5ZTJtIn0.hFpqesRFKogZg_ku3KKS_A';
        
        // Scale values for each tree type
        let scales = {
            'extra-large': 1.0,
            'large': 1.0,
            'medium': 1.0,
            'small': 1.0
        };
        
        // Initialize map
        const map = new mapboxgl.Map({
            container: 'map',
            center: [-74.945, 40.367], // Lambertville, NJ
            zoom: 16,
            pitch: 60,
            bearing: 0,
            style: 'mapbox://styles/deckdog/cmhpg30ke001u01rx9dda1l8i',
            minZoom: 14,
            maxZoom: 22,
            hash: true,
            antialias: true
        });

        // Set up scale controls
        ['extra-large', 'large', 'medium', 'small'].forEach(type => {
            const slider = document.getElementById(`scale-${type}`);
            const display = document.getElementById(`value-${type}`);
            
            slider.addEventListener('input', (e) => {
                scales[type] = parseFloat(e.target.value);
                display.textContent = e.target.value;
                updateTreeLayer();
            });
        });

        // Helper function to create model URL expression
        function createModelExpression() {
            // For each tree type, we'll use the random seed to pick a number 1-4
            // and concatenate it into the model filename
            return [
                'concat',
                MODEL_BASE_URL,
                ['get', 'type'],  // 'extra-large', 'large', 'medium', or 'small'
                '-tree-',
                [
                    'to-string',
                    [
                        '+',
                        1,
                        ['floor', ['random', 0, 4, ['id']]]  // Generates 1, 2, 3, or 4
                    ]
                ],
                '.glb'
            ];
        }

        // Helper function to create scale expression
        function createScaleExpression() {
            const extraLarge = scales['extra-large'];
            const large = scales['large'];
            const medium = scales['medium'];
            const small = scales['small'];
            
            return [
                'case',
                ['==', ['get', 'type'], 'extra-large'], ['literal', [extraLarge, extraLarge, extraLarge]],
                ['==', ['get', 'type'], 'large'], ['literal', [large, large, large]],
                ['==', ['get', 'type'], 'medium'], ['literal', [medium, medium, medium]],
                ['literal', [small, small, small]] // default to small
            ];
        }

        // Update tree layer with new scales
        function updateTreeLayer() {
            if (map.getLayer('tree-layer')) {
                map.setPaintProperty('tree-layer', 'model-scale', createScaleExpression());
            }
        }

        // Handle map style loading
        map.on('style.load', () => {
            // Set the light preset
            map.setConfigProperty('basemap', 'lightPreset', 'day');
            
            // Fetch and add the GeoJSON source
            fetch('./lambertville-trees-v1.geojson')
                .then(response => response.json())
                .then(data => {
                    // Add the trees GeoJSON source
                    map.addSource('trees', {
                        'type': 'geojson',
                        'data': data
                    });
                    
                    // Add the tree layer with the model data
                    map.addLayer({
                        'id': 'tree-layer',
                        'type': 'model',
                        'slot': 'middle',
                        'source': 'trees',
                        'layout': {
                            'model-id': createModelExpression()
                        },
                        'paint': {
                            // Slight color variation for visual interest
                            'model-color': [
                                'hsla',
                                ['random', 80, 120, ['id']],
                                50,
                                ['random', 40, 60, ['id']],
                                1
                            ],
                            'model-color-mix-intensity': 0.15,
                            // Fade in trees as you zoom in
                            'model-opacity': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                14, 0,
                                15, 1
                            ],
                            // Random rotation for natural appearance
                            'model-rotation': [
                                0, 0, ['random', 0, 360, ['id']]
                            ],
                            // Scale based on tree type and user controls
                            'model-scale': createScaleExpression(),
                            'model-cast-shadows': true
                        },
                        'minzoom': 14,
                        'maxzoom': 22
                    });
                })
                .catch(error => {
                    console.error('Error loading GeoJSON:', error);
                    alert('Failed to load tree data. Make sure lambertville-trees-v1.geojson is in the same directory as this HTML file.');
                });
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-left');

        // Performance optimization
        map.on('idle', () => {
            map.repaint = false;
        });

        map.on('move', () => {
            map.repaint = true;
        });
    </script>
</body>
</html>
